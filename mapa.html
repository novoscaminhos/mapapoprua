<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo da Rede de Apoio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        #map-container { position: relative; flex-grow: 1; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }
        @media (min-width: 769px) { #sidebar { height: 100vh; overflow-y: auto; } }
        @media (max-width: 768px) {
            #sidebar { position: fixed; bottom: 0; left: 0; right: 0; max-height: 50vh; overflow-y: auto; border-radius: 1rem 1rem 0 0; box-shadow: 0 -4px 12px rgba(0,0,0,0.1); z-index: 40; }
        }
        .directions-buttons { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .directions-buttons a { flex-grow: 1; padding: 0.5rem; border-radius: 0.375rem; text-align: center; color: white; font-weight: 600; transition: opacity 0.2s; }
        .directions-buttons a:hover { opacity: 0.9; }
        
        /* Estilo para o painel de legenda */
        #legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: white;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 10;
            font-size: 0.9rem;
        }
        #legend h3 { font-weight: 700; margin-bottom: 8px; }
        #legend div { display: flex; align-items: center; margin-bottom: 5px; }
        #legend img { width: 20px; height: 20px; margin-right: 8px; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-full bg-gray-100">

    <!-- Barra Lateral -->
    <div id="sidebar" class="w-full md:w-96 bg-white p-4 md:p-6 shadow-xl flex-shrink-0 z-30">
        <h1 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Rede de Apoio</h1>
        <p class="text-sm text-gray-500 mb-4">Selecione um local para ver detalhes e traçar sua rota.</p>
        <div id="detail-card" class="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-lg shadow-lg hidden" role="region">
            <div class="flex justify-between items-start mb-3">
                <h2 id="detail-card-title" class="text-lg font-bold text-purple-800"></h2>
                <button id="close-detail-card" class="text-gray-500 hover:text-gray-700 font-bold text-xl">&times;</button>
            </div>
            <div id="detail-card-content" class="text-sm text-gray-700 space-y-3"></div>
            <div class="directions-buttons">
                <a id="gmaps-btn" href="#" target="_blank" class="bg-blue-500">Google Maps</a>
                <a id="waze-btn" href="#" target="_blank" class="bg-cyan-500">Waze</a>
            </div>
        </div>
        <div id="status-box" class="mt-4 p-3 bg-yellow-100 text-yellow-800 rounded-lg text-sm hidden" role="alert"></div>
        <div id="destination-list" class="space-y-4 mt-6">
            <div class="text-center text-gray-400 p-4" id="loading-text">Carregando destinos...</div>
        </div>
        <div class="mt-8 border-t pt-4">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Minha Localização</h2>
            <button id="locate-me-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>
                Onde Estou?
            </button>
        </div>
    </div>

    <!-- Área do Mapa (agora com a legenda dentro) -->
    <div id="map-container">
        <div id="map"></div>
        <div id="legend" class="hidden">
            <h3>Legenda</h3>
            <!-- Conteúdo da legenda será gerado pelo JS -->
        </div>
    </div>

    <script>
        // --- ELEMENTOS DO DOM ---
        const detailCard = document.getElementById('detail-card'), detailCardTitle = document.getElementById('detail-card-title'), detailCardContent = document.getElementById('detail-card-content'), closeDetailCardBtn = document.getElementById('close-detail-card'), statusBox = document.getElementById('status-box'), destinationListContainer = document.getElementById('destination-list'), loadingText = document.getElementById('loading-text'), locateMeBtn = document.getElementById('locate-me-btn'), gmapsBtn = document.getElementById('gmaps-btn'), wazeBtn = document.getElementById('waze-btn'), legendPanel = document.getElementById('legend');

        // --- VARIÁVEIS GLOBAIS ---
        let map, userMarker, currentUserLocation = null, destinations = [], destinationMarkers = [];

        // --- CONFIGURAÇÕES DE CATEGORIA ---
        const categoryConfig = {
            servicos: { title: "Serviços Públicos", color: "blue", iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png" },
            apoio: { title: "Pontos de Apoio", color: "green", iconUrl: "https://maps.google.com/mapfiles/ms/icons/green-dot.png" },
            doacao: { title: "Pontos de Doação", color: "orange", iconUrl: "https://maps.google.com/mapfiles/ms/icons/orange-dot.png" }
        };

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), { zoom: 14, center: { lat: -21.7946, lng: -48.1766 }, mapTypeControl: false, streetViewControl: false });
            loadLocations();
            buildLegend();
        }

        async function loadLocations() {
            try {
                const response = await fetch('locations.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                destinations = await response.json();
                populateDestinationList();
                loadingText.classList.add('hidden');
            } catch (error) {
                console.error("Falha ao carregar locations.json:", error);
                loadingText.textContent = "Erro ao carregar os locais.";
                loadingText.classList.add("text-red-500");
            }
        }

        function buildLegend() {
            const legendContent = legendPanel.querySelector('h3');
            legendContent.insertAdjacentHTML('afterend', Object.values(categoryConfig).map(cat => `
                <div><img src="${cat.iconUrl}" alt="Ícone ${cat.color}"><span>${cat.title}</span></div>
            `).join(''));
            legendPanel.classList.remove('hidden');
        }

        function populateDestinationList() {
            destinationListContainer.innerHTML = '';
            const grouped = Object.fromEntries(Object.keys(categoryConfig).map(key => [key, []]));
            destinations.forEach(dest => grouped[dest.category]?.push(dest));

            for (const key in grouped) {
                const items = grouped[key];
                const config = categoryConfig[key];
                if (items.length === 0) continue;

                const titleEl = document.createElement('h3');
                titleEl.className = "text-lg font-semibold text-gray-600 border-b-2 pb-1";
                titleEl.textContent = config.title;
                destinationListContainer.appendChild(titleEl);

                const itemsContainer = document.createElement('div');
                itemsContainer.className = "space-y-2 pt-2";
                destinationListContainer.appendChild(itemsContainer);

                const shadow = `shadow-lg shadow-${config.color}-500/30`, hover = `hover:bg-${config.color}-100`, border = `border-${config.color}-200`;

                items.forEach(dest => {
                    const marker = new google.maps.Marker({ position: { lat: dest.lat, lng: dest.lng }, map, title: dest.name, icon: { url: config.iconUrl, scaledSize: new google.maps.Size(32, 32) } });
                    destinationMarkers.push(marker);

                    const btn = document.createElement('button');
                    btn.className = `w-full text-left p-3 bg-white border rounded-lg transition duration-200 ${shadow} ${hover} ${border}`;
                    btn.innerHTML = `<span class="font-semibold text-gray-800">${dest.name}</span>`;
                    btn.onclick = () => showDetails(dest);
                    itemsContainer.appendChild(btn);
                    marker.addListener('click', () => showDetails(dest));
                });
            }
        }

        async function showDetails(destination) {
            statusBox.classList.add('hidden');
            detailCard.classList.remove('hidden');
            detailCardTitle.textContent = destination.name;
            
            // Conteúdo inicial com placeholder para os detalhes
            detailCardContent.innerHTML = `
                <p class="text-gray-600 font-semibold">${destination.address}</p>
                <div id="dynamic-details" class="mt-2 p-3 bg-gray-100 rounded-md text-gray-500 animate-pulse">Buscando mais detalhes...</div>
            `;

            map.panTo({ lat: destination.lat, lng: destination.lng });
            if (map.getZoom() < 16) map.setZoom(16);
            updateRouteButtons(destination.lat, destination.lng);

            // Busca os detalhes dinâmicos
            const details = await fetchDynamicDetails(destination);
            const detailsContainer = document.getElementById('dynamic-details');
            detailsContainer.innerHTML = details;
            detailsContainer.classList.remove('animate-pulse', 'text-gray-500');
        }

        async function fetchDynamicDetails(destination) {
            // Se houver detalhes pré-definidos no JSON, use-os.
            if (destination.details) {
                return `<p>${destination.details}</p>`;
            }
            
            // SIMULAÇÃO DE CHAMADA DE API:
            // Substitua esta parte pela sua chamada real à API Gemini ou outra.
            // O setTimeout simula a demora da rede.
            return new Promise(resolve => {
                setTimeout(() => {
                    // Exemplo de resposta que a API poderia retornar
                    const simulatedResponse = `Este é um ponto de referência importante na cidade, conhecido por oferecer suporte à comunidade local. Funciona de segunda a sexta, das 8h às 17h.`;
                    resolve(`<p>${simulatedResponse}</p>`);
                }, 1500); // Simula 1.5 segundos de espera
            });
        }

        function updateRouteButtons(destLat, destLng) {
            wazeBtn.href = `https://waze.com/ul?ll=${destLat},${destLng}&navigate=yes`;
            gmapsBtn.href = currentUserLocation ? `https://www.google.com/maps/dir/?api=1&origin=${currentUserLocation.lat},${currentUserLocation.lng}&destination=${destLat},${destLng}&travelmode=driving` : `https://www.google.com/maps/search/?api=1&query=${destLat},${destLng}`;
        }

        function locateUser() {
            showStatus("Obtendo sua localização...", false);
            if (!navigator.geolocation) {
                showStatus("Geolocalização não é suportada pelo seu navegador.", true);
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentUserLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                    showStatus("Sua localização foi marcada no mapa!", false);
                    if (userMarker) userMarker.setPosition(currentUserLocation);
                    else userMarker = new google.maps.Marker({ position: currentUserLocation, map, title: "Sua Localização", icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#4285F4", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" } });
                    map.setCenter(currentUserLocation);
                    map.setZoom(17);
                    if (!detailCard.classList.contains('hidden')) {
                        const openDest = destinations.find(d => d.name === detailCardTitle.textContent);
                        if (openDest) updateRouteButtons(openDest.lat, openDest.lng);
                    }
                },
                () => showStatus("Não foi possível obter sua localização. Verifique as permissões.", true)
            );
        }

        function showStatus(text, isError = false) {
            statusBox.textContent = text;
            statusBox.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
            statusBox.classList.add(isError ? 'bg-red-100' : 'bg-yellow-100', isError ? 'text-red-800' : 'text-yellow-800');
        }

        locateMeBtn.addEventListener('click', locateUser);
        closeDetailCardBtn.addEventListener('click', () => detailCard.classList.add('hidden'));
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTmQ_VAG5vGUroDiyn9mDOexOGPgUQlW8&callback=initMap&libraries=marker"></script>
</body>
</html>
