/*!
 * MarkerClusterer v1.0.3 - Google Maps JavaScript API v3
 * https://github.com/googlemaps/v3-utility-library
 * Licensed under the Apache License, Version 2.0
 */
var MarkerClusterer=function(map,opt_options){this.extend(MarkerClusterer,google.maps.OverlayView);this.map_=map;this.markers_=[];this.clusters_=[];var options=opt_options||{};this.gridSize_=options.gridSize||60;this.minClusterSize_=options.minimumClusterSize||2;this.maxZoom_=options.maxZoom||null;this.styles_=options.styles||[];this.zoomOnClick_=true;if(options.zoomOnClick!==undefined){this.zoomOnClick_=options.zoomOnClick;}this.averageCenter_=false;if(options.averageCenter!==undefined){this.averageCenter_=options.averageCenter;}this.ignoreHidden_=false;if(options.ignoreHidden!==undefined){this.ignoreHidden_=options.ignoreHidden;}this.enableRetinaIcons_=false;if(options.enableRetinaIcons!==undefined){this.enableRetinaIcons_=options.enableRetinaIcons;}this.imagePath_=options.imagePath||"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m";this.imageExtension_=options.imageExtension||"png";this.imageSizes_=options.imageSizes||[53,56,66,78,90];this.setupStyles_();this.setMap(map);this.prevZoom_=-1;var that=this;google.maps.event.addListener(this.map_,"zoom_changed",function(){var zoom=that.map_.getZoom();if(that.prevZoom_!=zoom){that.prevZoom_=zoom;that.resetViewport();}});google.maps.event.addListener(this.map_,"idle",function(){that.redraw();});if(options.markers){this.addMarkers(options.markers);}};

MarkerClusterer.prototype={onAdd:function(){this.setReady_(true);},draw:function(){},setupStyles_:function(){if(this.styles_.length>0){return;}for(var i=0;i<this.imageSizes_.length;i++){this.styles_.push({url:this.imagePath_+(i+1)+"."+this.imageExtension_,height:this.imageSizes_[i],width:this.imageSizes_[i]});}},fitMapToMarkers:function(){var bounds=new google.maps.LatLngBounds();for(var i=0;i<this.markers_.length;i++){if(this.markers_[i].getVisible()){bounds.extend(this.markers_[i].getPosition());}}this.map_.fitBounds(bounds);},setStyles:function(styles){this.styles_=styles;},getStyles:function(){return this.styles_;},isZoomOnClick:function(){return this.zoomOnClick_;},isAverageCenter:function(){return this.averageCenter_;},getMarkers:function(){return this.markers_;},getTotalMarkers:function(){return this.markers_.length;},addMarker:function(marker,opt_nodraw){this.pushMarkerTo_(marker);if(!opt_nodraw){this.redraw();}},addMarkers:function(markers,opt_nodraw){for(var i=0,len=markers.length;i<len;i++){this.pushMarkerTo_(markers[i]);}if(!opt_nodraw){this.redraw();}},pushMarkerTo_:function(marker){marker.isAdded=false;if(marker["draggable"]){var that=this;google.maps.event.addListener(marker,"dragend",function(){marker.isAdded=false;that.repaint();});}this.markers_.push(marker);},removeMarker:function(marker,opt_nodraw){var index=-1;if(this.markers_.indexOf){index=this.markers_.indexOf(marker);}else{for(var i=0,len=this.markers_.length;i<len;i++){if(marker===this.markers_[i]){index=i;break;}}}if(index==-1){return false;}marker.setMap(null);this.markers_.splice(index,1);if(!opt_nodraw){this.resetViewport();this.redraw();}return true;},removeMarkers:function(markers,opt_nodraw){var removed=true;for(var i=0,len=markers.length;i<len;i++){removed=this.removeMarker(markers[i],true)&&removed;}if(!opt_nodraw){this.resetViewport();this.redraw();}return removed;},setReady_:function(ready){if(!this.ready_){this.ready_=ready;this.createClusters_();}},getTotalClusters:function(){return this.clusters_.length;},resetViewport:function(){for(var i=0,len=this.clusters_.length;i<len;i++){this.clusters_[i].remove();}this.clusters_=[];for(var i=0,len=this.markers_.length;i<len;i++){this.markers_[i].isAdded=false;}},repaint:function(){var oldClusters=this.clusters_.slice();this.clusters_.length=0;this.resetViewport();this.redraw();setTimeout(function(){for(var i=0,len=oldClusters.length;i<len;i++){oldClusters[i].remove();}},0);},redraw:function(){this.createClusters_();},createClusters_:function(){if(!this.ready_){return;}var mapBounds=new google.maps.LatLngBounds(this.map_.getBounds().getSouthWest(),this.map_.getBounds().getNorthEast());for(var i=0,len=this.markers_.length;i<len;i++){var marker=this.markers_[i];if(!marker.isAdded&&marker.getVisible()){var pos=marker.getPosition();if(mapBounds.contains(pos)){this.addToClosestCluster_(marker);}}}},addToClosestCluster_:function(marker){var cluster=null;var distance=40000;for(var i=0,len=this.clusters_.length;i<len;i++){var c=this.clusters_[i];var d=this.distanceBetweenPoints_(c.getCenter(),marker.getPosition());if(d<distance){distance=d;cluster=c;}}if(cluster&&cluster.isMarkerInClusterBounds(marker)){cluster.addMarker(marker);}else{var cluster=new Cluster(this);cluster.addMarker(marker);this.clusters_.push(cluster);}},distanceBetweenPoints_:function(p1,p2){if(!p1||!p2){return 0;}var R=6371;var dLat=(p2.lat()-p1.lat())*Math.PI/180;var dLon=(p2.lng()-p1.lng())*Math.PI/180;var lat1=p1.lat()*Math.PI/180;var lat2=p2.lat()*Math.PI/180;var a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.sin(dLon/2)*Math.sin(dLon/2)*Math.cos(lat1)*Math.cos(lat2);var c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));return R*c;}};

var Cluster=function(mc){this.markerClusterer_=mc;this.map_=mc.map_;this.gridSize_=mc.gridSize_;this.minClusterSize_=mc.minClusterSize_;this.averageCenter_=mc.averageCenter_;this.center_=null;this.markers_=[];this.bounds_=null;this.clusterIcon_=new ClusterIcon(this,mc.styles_,mc.gridSize_);};

Cluster.prototype={addMarker:function(marker){if(this.markers_.indexOf&&this.markers_.indexOf(marker)!=-1){return false;}marker.isAdded=true;this.markers_.push(marker);if(!this.center_){this.center_=marker.getPosition();this.calculateBounds_();}else{if(this.averageCenter_){var l=this.markers_.length;var lat=(this.center_.lat()*(l-1)+marker.getPosition().lat())/l;var lng=(this.center_.lng()*(l-1)+marker.getPosition().lng())/l;this.center_=new google.maps.LatLng(lat,lng);this.calculateBounds_();}}if(this.markers_.length<this.minClusterSize_){return true;}if(this.markers_.length==this.minClusterSize_){for(var i=0;i<this.markers_.length;i++){this.markers_[i].setMap(null);} }else{marker.setMap(null);}this.updateIcon_();return true;},getCenter:function(){return this.center_;},getMarkers:function(){return this.markers_.slice();},getBounds:function(){var bounds=new google.maps.LatLngBounds(this.center_,this.center_);var markers=this.getMarkers();for(var i=0,len=markers.length;i<len;i++){bounds.extend(markers[i].getPosition());}return bounds;},remove:function(){for(var i=0,len=this.markers_.length;i<len;i++){this.markers_[i].setMap(this.map_);}this.markers_.length=0;this.clusterIcon_.remove();},isMarkerInClusterBounds:function(marker){return this.bounds_.contains(marker.getPosition());},calculateBounds_:function(){var bounds=new google.maps.LatLngBounds(this.center_,this.center_);this.bounds_=bounds;this.bounds_.extend(this.fromLatLngToPixel_(this.center_,1));this.bounds_.extend(this.fromLatLngToPixel_(this.center_,-1));},fromLatLngToPixel_:function(latlng,multiplier){var proj=this.map_.getProjection();var point=proj.fromLatLngToPoint(latlng);return proj.fromPointToLatLng(new google.maps.Point(point.x+multiplier*this.gridSize_/256,point.y));},updateIcon_:function(){var zoom=this.map_.getZoom();var mz=this.markerClusterer_.maxZoom_;if(mz&&zoom>mz){for(var i=0,len=this.markers_.length;i<len;i++){this.markers_[i].setMap(this.map_);}this.clusterIcon_.hide();return;}var num=this.markers_.length;var style=this.markerClusterer_.getStyles()[Math.min(this.markerClusterer_.getStyles().length-1,Math.floor(num/10))];this.clusterIcon_.setCenter(this.center_);this.clusterIcon_.setSums(num);this.clusterIcon_.useStyle(style);this.clusterIcon_.show();}};

var ClusterIcon=function(cluster,styles,gridSize){cluster.getMarkerClusterer().extend(ClusterIcon,google.maps.OverlayView);this.styles_=styles;this.cluster_=cluster;this.className_="cluster-marker";this.center_=null;this.div_=null;this.sums_=null;this.visible_=
false;this.gridSize_=gridSize;this.setMap(cluster.getMarkerClusterer().getMap());};

ClusterIcon.prototype={onAdd:function(){var div=document.createElement("DIV");div.className=this.className_;if(this.visible_){div.style.cssText=this.createCss_(this.center_);}this.div_=div;var panes=this.getPanes();panes.overlayImage.appendChild(div);var that=this;google.maps.event.addDomListener(div,"click",function(){that.triggerClusterClick();});},draw:function(){if(!this.visible_){return;}var pos=this.getProjection().fromLatLngToDivPixel(this.center_);this.div_.style.top=pos.y+"px";this.div_.style.left=pos.x+"px";},onRemove:function(){if(this.div_&&this.div_.parentNode){this.div_.parentNode.removeChild(this.div_);}this.div_=null;},hide:function(){if(this.div_){this.div_.style.display="none";}this.visible_=false;},show:function(){if(this.div_){this.div_.style.display="block";}this.visible_=true;},setCenter:function(center){this.center_=center;},setSums:function(sums){this.sums_=sums;},useStyle:function(style){this.url_=style.url;this.height_=style.height;this.width_=style.width;},createCss_:function(center){var pos=this.getProjection().fromLatLngToDivPixel(center);return "cursor:pointer; position:absolute; top:"+pos.y+"px; left:"+pos.x+"px; width:"+this.width_+"px; height:"+this.height_+"px; line-height:"+this.height_+"px; background:url("+this.url_+"); text-align:center; color:#fff; font-size:14px;";},triggerClusterClick:function(){var mc=this.cluster_.getMarkerClusterer();google.maps.event.trigger(mc,"clusterclick",this.cluster_);}};

MarkerClusterer.prototype.extend=function(obj1,obj2){return (function(object){for(var property in object.prototype){this.prototype[property]=object.prototype[property];}return this;})(obj2);};
