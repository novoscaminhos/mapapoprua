<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rede de Apoio - Araraquara/SP</title>
    <style>
        /* Estilos para garantir o layout de tela cheia */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        /* Menu lateral */
        #sidebar {
            width: 350px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        
        #sidebar-header {
            padding: 20px;
            background-color: #2E312F;
            color: white;
            text-align: center;
        }

        #sidebar-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        /* Estilos para a seção de filtros */
        #sidebar-filters {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background-color: #f1f1f1;
        }

        #search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }

        #category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-btn {
            background-color: #e7e7e7;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-btn:hover {
            background-color: #ddd;
        }

        .category-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* Container para a lista e o painel de detalhes */
        #sidebar-content-wrapper {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        /* Lista de locais */
        #location-list-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
        }

        #location-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        #location-list li {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }

        #location-list li:hover {
            background-color: #e9ecef;
        }
        
        #location-list li.active {
            background-color: #d4edda;
        }

        /* Painel de Detalhes */
        #details-panel {
            position: absolute;
            top: 0;
            left: 100%; /* Começa fora da tela, à direita */
            width: 100%;
            height: 100%;
            background-color: white;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Estado ativo do painel de detalhes */
        #sidebar.details-active #location-list-container {
            transform: translateX(-100%); /* Move a lista para fora da tela */
        }

        #sidebar.details-active #details-panel {
            transform: translateX(-100%); /* Move o painel de detalhes para a posição 0 */
        }

        /* Estilos do conteúdo do painel */
        #details-panel h3 {
            margin-top: 0;
            color: #2E312F;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .detail-item {
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .detail-item strong {
            display: block;
            color: #555;
            font-size: 0.9em;
        }

        #back-to-list-btn {
            background: none;
            border: none;
            color: #4285F4;
            padding: 0;
            margin-bottom: 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        #back-to-list-btn:hover {
            text-decoration: underline;
        }

        #get-directions-btn-details {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 1em;
            width: 100%;
        }

        #get-directions-btn-details:hover {
            background-color: #357ae8;
        }

        /* Mapa */
        #map {
            flex-grow: 1;
            height: 100%;
        }
    </style>
</head>
<body>

    <div id="container">
        <!-- Menu Lateral -->
        <div id="sidebar">
            <div id="sidebar-header">
                <h2>Rede de Apoio - Araraquara/SP</h2>
            </div>

            <!-- Seção de Filtros e Busca -->
            <div id="sidebar-filters">
                <input type="text" id="search-box" placeholder="Buscar por nome ou endereço...">
                <div id="category-filters">
                    <!-- Os botões de categoria serão inseridos aqui pelo JavaScript -->
                </div>
            </div>

            <div id="sidebar-content-wrapper">
                <!-- Container da Lista de Locais -->
                <div id="location-list-container">
                    <ul id="location-list">
                        <!-- A lista de locais será preenchida via JavaScript -->
                    </ul>
                </div>

                <!-- Painel de Detalhes do Local -->
                <div id="details-panel">
                    <button id="back-to-list-btn" onclick="hideDetailsPanel()">
                        &#x25C0; Voltar para a Lista
                    </button>
                    <h3 id="detail-name"></h3>
                    <div id="detail-category" class="detail-item"></div>
                    <div id="detail-address" class="detail-item"></div>
                    <div id="detail-details" class="detail-item"></div>
                    <div id="detail-phone" class="detail-item"></div>
                    <div id="detail-hours" class="detail-item"></div>
                    
                    <!-- Botão de Rota -->
                    <button id="get-directions-btn-details">
                        Como chegar a este local
                    </button>

                    <!-- Espaço para a Busca com IA (Passo 5) -->
                    <div id="ai-info-section" class="detail-item">
                        <button id="ai-search-btn" onclick="fetchAIInfo()">
                            Buscar Detalhes com IA
                        </button>
                        <div id="ai-result" style="margin-top: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; display: none;">
                            <!-- Resultado da IA será inserido aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onde o mapa será renderizado -->
        <div id="map"></div>
    </div>

    <script>
        // URL da sua Planilha Google (CSV)
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vStW-bhkRBtUEX_4npJm9fx-8NYux7D41CDLmhD3TRAujeEdic9oU4VGmYpoLG9idEidjHyhoCfJFDK/pub?output=csv';

        // Definição das categorias com base no seu KML
        const categories = {
            'Serviços Públicos de Referência': {
                name: "Serviços Públicos",
                iconUrl: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            },
            'Pontos de Apoio e Parcerias': {
                name: "Apoio e Parcerias",
                iconUrl: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
            },
            'Pontos de doação': {
                name: "Pontos de Doação",
                iconUrl: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
            }
        };

        let map;
        let directionsService;
        let directionsRenderer;
        let locations = [];
        const markers = [];
        let activeLocation = null;

        // Função para carregar e parsear o CSV da Planilha Google
        async function loadDataFromSheet( ) {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                
                // Simples parser CSV: divide por linha e depois por vírgula
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                const headers = lines[0].split(',').map(header => header.trim());
                
                const data = lines.slice(1).map(line => {
                    const values = line.split(',');
                    let obj = {};
                    headers.forEach((header, i) => {
                        obj[header] = values[i] ? values[i].trim().replace(/^"|"$/g, '') : '';
                    });
                    // Converte lat/lng para números
                    obj.lat = parseFloat(obj.lat);
                    obj.lng = parseFloat(obj.lng);
                    return obj;
                });

                locations = data.filter(loc => loc.lat && loc.lng);
                console.log(`Dados carregados: ${locations.length} locais encontrados.`);

            } catch (error) {
                console.error("Erro ao carregar dados da planilha:", error);
                alert("Erro ao carregar os dados do mapa. Verifique o link da planilha.");
            }
        }

        async function initMap() {
            // 1. Carrega os dados da planilha antes de tudo
            await loadDataFromSheet();

            // 2. Inicializa o mapa
            const initialPosition = { lat: -21.7915, lng: -48.1739 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: initialPosition,
                mapTypeControl: false,
                streetViewControl: false
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            const locationList = document.getElementById('location-list');
            const categoryFiltersContainer = document.getElementById('category-filters');

            // 3. Criação dos botões de filtro
            const allButton = document.createElement('button');
            allButton.className = 'category-btn active';
            allButton.textContent = 'Todos';
            allButton.dataset.category = 'all';
            categoryFiltersContainer.appendChild(allButton);

            for (const categoryId in categories) {
                const category = categories[categoryId];
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category.name;
                button.dataset.category = categoryId;
                categoryFiltersContainer.appendChild(button);
            }

            // 4. Criação dos marcadores e da lista
            locations.forEach((location, index) => {
                const categoryInfo = categories[location.category];
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: location.name,
                    animation: google.maps.Animation.DROP,
                    icon: categoryInfo ? categoryInfo.iconUrl : undefined
                });
                markers.push(marker);

                const listItem = document.createElement('li');
                const categoryName = categoryInfo ? categoryInfo.name : 'Sem Categoria';
                listItem.innerHTML = `<strong>${location.name}</strong>  
<small>${location.address || categoryName}</small>`;
                listItem.dataset.index = index;
                locationList.appendChild(listItem);

                // Evento de clique no marcador e na lista agora chama showDetailsPanel
                marker.addListener('click', () => {
                    showDetailsPanel(location, marker, index);
                });

                listItem.addEventListener('click', () => {
                    showDetailsPanel(location, marker, index);
                });
            });

            // 5. Adiciona eventos de filtro
            categoryFiltersContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('category-btn')) {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    filterLocations();
                }
            });

            document.getElementById('search-box').addEventListener('keyup', filterLocations);

            // Evento para o botão "Como Chegar" no painel de detalhes
            document.getElementById('get-directions-btn-details').addEventListener('click', () => {
                if (activeLocation) {
                    calculateRouteTo(activeLocation.lat, activeLocation.lng);
                }
            });

            filterLocations();
        }

        // Função para buscar informações com IA (Simulação)
        async function fetchAIInfo() {
            const aiButton = document.getElementById('ai-search-btn');
            const aiResultDiv = document.getElementById('ai-result');
            
            if (!activeLocation) return;

            // 1. Prepara a interface para a busca
            aiButton.disabled = true;
            aiButton.textContent = 'Buscando... (Isso pode levar alguns segundos)';
            aiResultDiv.style.display = 'block';
            aiResultDiv.innerHTML = 'Aguarde, a IA está pesquisando sobre: <strong>' + activeLocation.name + '</strong>...';

            // 2. SIMULAÇÃO: Gerando um texto de exemplo
            await new Promise(resolve => setTimeout(resolve, 3000)); // Espera 3 segundos para simular a busca
            
            const aiText = `
                <p><strong>Análise da IA:</strong></p>
                <p>O local <strong>${activeLocation.name}</strong>, em ${activeLocation.address || 'Araraquara/SP'}, é um ponto vital na rede de apoio. A pesquisa de IA sugere que, além dos serviços básicos, o local tem sido destaque em iniciativas de reintegração social, com foco em oficinas de capacitação profissional. Verifique o site oficial da prefeitura para confirmar a agenda de eventos e doações.</p>
                <p><em>(Esta é uma simulação. Para ter uma busca real, você precisará de um servidor intermediário.)</em></p>
            `;

            // 3. Exibe o resultado
            aiResultDiv.innerHTML = aiText;
            aiButton.disabled = false;
            aiButton.textContent = 'Buscar Detalhes com IA';
        }

        // Função para mostrar o painel de detalhes
        function showDetailsPanel(location, marker, index) {
            const sidebar = document.getElementById('sidebar');
            const categoryInfo = categories[location.category];
            
            // Limpa o resultado da IA ao abrir um novo local
            document.getElementById('ai-result').style.display = 'none';
            document.getElementById('ai-result').innerHTML = '';
            document.getElementById('ai-search-btn').disabled = false;
            document.getElementById('ai-search-btn').textContent = 'Buscar Detalhes com IA';

            // 1. Atualiza o conteúdo do painel
            document.getElementById('detail-name').textContent = location.name;
            document.getElementById('detail-category').innerHTML = `<strong>Categoria:</strong> ${categoryInfo ? categoryInfo.name : 'Não classificada'}`;
            document.getElementById('detail-address').innerHTML = `<strong>Endereço:</strong> ${location.address || 'Não informado'}`;
            document.getElementById('detail-details').innerHTML = `<strong>Detalhes:</strong> ${location.details || 'Nenhuma descrição disponível.'}`;
            document.getElementById('detail-phone').innerHTML = location.phone ? `<strong>Telefone:</strong> ${location.phone}` : '';
            document.getElementById('detail-hours').innerHTML = location.hours ? `<strong>Horário:</strong> ${location.hours}` : '';

            // 2. Armazena o local ativo e centraliza o mapa
            activeLocation = location;
            map.panTo(marker.getPosition());
            map.setZoom(15);

            // 3. Adiciona a classe para a transição CSS
            sidebar.classList.add('details-active');
            
            // 4. Destaca o item na lista
            highlightListItem(index);
        }

        // Função para esconder o painel de detalhes
        function hideDetailsPanel() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.remove('details-active');
            activeLocation = null;
            highlightListItem(-1); // Remove o destaque da lista
            directionsRenderer.setDirections({ routes: [] }); // Limpa a rota
            
            // NOVO: Garante que todos os marcadores voltem a ser visíveis
            markers.forEach(marker => marker.setVisible(true));
        }

        function calculateRouteTo(destLat, destLng) {
            // NOVO: Esconde todos os marcadores antes de calcular a rota
            markers.forEach(marker => marker.setVisible(false));

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const origin = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        
                        const request = {
                            origin: origin,
                            destination: { lat: destLat, lng: destLng },
                            travelMode: google.maps.TravelMode.WALKING
                        };

                        directionsService.route(request, (result, status) => {
                            if (status == 'OK') {
                                directionsRenderer.setDirections(result);
                                // O DirectionsRenderer já cuida de exibir o marcador de destino.
                                // Apenas limpamos o destaque da lista.
                                highlightListItem(-1); 
                            } else {
                                window.alert('Não foi possível calcular a rota: ' + status);
                                // NOVO: Se falhar, reexibe todos os marcadores
                                markers.forEach(marker => marker.setVisible(true));
                            }
                        });
                    },
                    () => {
                        alert('Não foi possível obter sua localização. Verifique as permissões do navegador.');
                        // NOVO: Se falhar, reexibe todos os marcadores
                        markers.forEach(marker => marker.setVisible(true));
                    }
                );
            } else {
                alert('Seu navegador não suporta geolocalização.');
                // NOVO: Se falhar, reexibe todos os marcadores
                markers.forEach(marker => marker.setVisible(true));
            }
        }

        function highlightListItem(index) {
            document.querySelectorAll('#location-list li').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`#location-list li[data-index='${index}']`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        function calculateRouteTo(destLat, destLng) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const origin = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        
                        const request = {
                            origin: origin,
                            destination: { lat: destLat, lng: destLng },
                            travelMode: google.maps.TravelMode.WALKING
                        };

                        directionsService.route(request, (result, status) => {
                            if (status == 'OK') {
                                directionsRenderer.setDirections(result);
                                highlightListItem(-1); 
                            } else {
                                window.alert('Não foi possível calcular a rota: ' + status);
                            }
                        });
                    },
                    () => {
                        alert('Não foi possível obter sua localização. Verifique as permissões do navegador.');
                    }
                );
            } else {
                alert('Seu navegador não suporta geolocalização.');
            }
        }

        window.initMap = initMap;
    </script>

    <!-- Carrega a API do Google Maps e, ao terminar, chama a função initMap -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCxVq0rVgMGEkOAt2k_UhxhVNGg8BMp5gw&callback=initMap"></script>

</body>
</html>
