<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rede de Apoio - Araraquara/SP</title>
    <style>
        /* Estilos para garantir o layout de tela cheia */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            display: flex;
            height: 100vh;
        }

        /* Menu lateral */
        #sidebar {
            width: 350px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }
        
        #sidebar-header {
            padding: 20px;
            background-color: #2E312F;
            color: white;
            text-align: center;
        }

        #sidebar-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        /* Estilos para a seção de filtros */
        #sidebar-filters {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background-color: #f1f1f1;
        }

        #search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            margin-bottom: 15px;
        }

        #category-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .category-btn {
            background-color: #e7e7e7;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .category-btn:hover {
            background-color: #ddd;
        }

        .category-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        #location-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }

        #location-list li {
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }

        #location-list li:hover {
            background-color: #e9ecef;
        }
        
        #location-list li.active {
            background-color: #d4edda;
        }

        /* Mapa */
        #map {
            flex-grow: 1;
            height: 100%;
        }

        /* Estilos para a janela de informações (InfoWindow ) */
        .info-window-content {
            max-width: 300px;
        }
        .info-window-content h3 {
            margin: 0 0 10px 0;
        }
        .info-window-content p {
            margin: 5px 0;
        }
        .get-directions-btn {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }
        .get-directions-btn:hover {
            background-color: #357ae8;
        }
    </style>
</head>
<body>

    <div id="container">
        <!-- Menu Lateral -->
        <div id="sidebar">
            <div id="sidebar-header">
                <h2>Rede de Apoio - Araraquara/SP</h2>
            </div>

            <!-- Seção de Filtros e Busca -->
            <div id="sidebar-filters">
                <input type="text" id="search-box" placeholder="Buscar por nome ou endereço...">
                <div id="category-filters">
                    <!-- Os botões de categoria serão inseridos aqui pelo JavaScript -->
                </div>
            </div>

            <ul id="location-list">
                <!-- A lista de locais será preenchida via JavaScript -->
            </ul>
        </div>

        <!-- Onde o mapa será renderizado -->
        <div id="map"></div>
    </div>

    <script>
        // URL da sua Planilha Google (CSV)
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vStW-bhkRBtUEX_4npJm9fx-8NYux7D41CDLmhD3TRAujeEdic9oU4VGmYpoLG9idEidjHyhoCfJFDK/pub?output=csv';

        // Definição das categorias com base no seu KML
        const categories = {
            'Serviços Públicos de Referência': {
                name: "Serviços Públicos",
                iconUrl: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            },
            'Pontos de Apoio e Parcerias': {
                name: "Apoio e Parcerias",
                iconUrl: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
            },
            'Pontos de doação': {
                name: "Pontos de Doação",
                iconUrl: "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
            }
        };

        let map;
        let infoWindow;
        let directionsService;
        let directionsRenderer;
        let locations = []; // A lista de locais será preenchida com os dados da planilha
        const markers = [];

        // Função para carregar e parsear o CSV da Planilha Google
        async function loadDataFromSheet( ) {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                
                // Simples parser CSV: divide por linha e depois por vírgula
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                const headers = lines[0].split(',').map(header => header.trim());
                
                const data = lines.slice(1).map(line => {
                    const values = line.split(',');
                    let obj = {};
                    headers.forEach((header, i) => {
                        // Remove aspas e espaços em branco
                        obj[header] = values[i] ? values[i].trim().replace(/^"|"$/g, '') : '';
                    });
                    // Converte lat/lng para números
                    obj.lat = parseFloat(obj.lat);
                    obj.lng = parseFloat(obj.lng);
                    return obj;
                });

                locations = data.filter(loc => loc.lat && loc.lng); // Filtra locais sem coordenadas válidas
                console.log(`Dados carregados: ${locations.length} locais encontrados.`);

            } catch (error) {
                console.error("Erro ao carregar dados da planilha:", error);
                alert("Erro ao carregar os dados do mapa. Verifique o link da planilha.");
            }
        }

        // Função principal que agora é assíncrona
        async function initMap() {
            // 1. Carrega os dados da planilha antes de tudo
            await loadDataFromSheet();

            // 2. Inicializa o mapa
            // Usamos o centro de Araraquara/SP como posição inicial
            const initialPosition = { lat: -21.7915, lng: -48.1739 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: initialPosition,
                mapTypeControl: false,
                streetViewControl: false
            });

            infoWindow = new google.maps.InfoWindow();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            directionsRenderer.setMap(map);

            const locationList = document.getElementById('location-list');
            const categoryFiltersContainer = document.getElementById('category-filters');

            // 3. Criação dos botões de filtro
            const allButton = document.createElement('button');
            allButton.className = 'category-btn active';
            allButton.textContent = 'Todos';
            allButton.dataset.category = 'all';
            categoryFiltersContainer.appendChild(allButton);

            for (const categoryId in categories) {
                const category = categories[categoryId];
                const button = document.createElement('button');
                button.className = 'category-btn';
                button.textContent = category.name;
                button.dataset.category = categoryId;
                categoryFiltersContainer.appendChild(button);
            }

            // 4. Criação dos marcadores e da lista
            locations.forEach((location, index) => {
                const categoryInfo = categories[location.category];
                const marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: location.name,
                    animation: google.maps.Animation.DROP,
                    icon: categoryInfo ? categoryInfo.iconUrl : undefined
                });
                               // Evento de clique no marcador e na lista agora chama showDetailsPanel
                marker.addListener('click', () => {
                    showDetailsPanel(location, marker, index); // <--- CORRETO: Chama o novo painel
                });

                listItem.addEventListener('click', () => {
                    showDetailsPanel(location, marker, index); // <--- CORRETO: Chama o novo painel
                });


            // 5. Adiciona eventos de filtro
            categoryFiltersContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('category-btn')) {
                    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    filterLocations();
                }
            });

            document.getElementById('search-box').addEventListener('keyup', filterLocations);

            filterLocations(); // Chama o filtro na inicialização
        }

        function filterLocations() {
            const activeCategoryElement = document.querySelector('.category-btn.active');
            const activeCategory = activeCategoryElement ? activeCategoryElement.dataset.category : 'all';
            const searchTerm = document.getElementById('search-box').value.toLowerCase();

            locations.forEach((location, index) => {
                const listItem = document.querySelector(`#location-list li[data-index='${index}']`);
                const marker = markers[index];

                const categoryMatch = (activeCategory === 'all' || location.category === activeCategory);
                const searchMatch = (
                    location.name.toLowerCase().includes(searchTerm) ||
                    location.address.toLowerCase().includes(searchTerm)
                );

                if (categoryMatch && searchMatch) {
                    listItem.style.display = '';
                    if(marker) marker.setVisible(true);
                } else {
                    listItem.style.display = 'none';
                    if(marker) marker.setVisible(false);
                }
            });
        }

        function showLocationInfo(location, marker, index) {
            const content = `
                <div class="info-window-content">
                    <h3>${location.name}</h3>
                    <p><strong>Endereço:</strong> ${location.address || 'Não informado'}</p>
                    <p><strong>Detalhes:</strong> ${location.details || 'Não informado'}</p>
                    ${location.phone ? `<p><strong>Telefone:</strong> ${location.phone}</p>` : ''}
                    ${location.hours ? `<p><strong>Horário:</strong> ${location.hours}</p>` : ''}
                    <button class="get-directions-btn" onclick="calculateRouteTo(${location.lat}, ${location.lng})">
                        Como chegar
                    </button>
                </div>
            `;
            infoWindow.setContent(content);
            infoWindow.open(map, marker);
            highlightListItem(index);
        }
        
        function highlightListItem(index) {
            document.querySelectorAll('#location-list li').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`#location-list li[data-index='${index}']`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        function calculateRouteTo(destLat, destLng) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const origin = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        
                        const request = {
                            origin: origin,
                            destination: { lat: destLat, lng: destLng },
                            travelMode: google.maps.TravelMode.WALKING
                        };

                        directionsService.route(request, (result, status) => {
                            if (status == 'OK') {
                                directionsRenderer.setDirections(result);
                                infoWindow.close();
                                highlightListItem(-1);
                            } else {
                                window.alert('Não foi possível calcular a rota: ' + status);
                            }
                        });
                    },
                    () => {
                        alert('Não foi possível obter sua localização. Verifique as permissões do navegador.');
                    }
                );
            } else {
                alert('Seu navegador não suporta geolocalização.');
            }
        }

        window.initMap = initMap;
    </script>

    <!-- Carrega a API do Google Maps e, ao terminar, chama a função initMap -->
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTmQ_VAG5vGUroDiyn9mDOexOGPgUQlW8&callback=initMap"></script>

</body>
</html>
